id: https://open-and-sustainable.github.io/revaise-model/schema/stages/registration
name: revaise_registration
description: "Registration stage for systematic reviews, supporting both pre-registration and registration with comprehensive versioning and amendment tracking."
prefixes:
    linkml: https://w3id.org/linkml/
    revaise: https://open-and-sustainable.github.io/revaise-model/schema/
default_prefix: revaise
imports:
    - linkml:types
    - ../objects/stage_execution
    - ../objects/author

classes:
    RegistrationStage:
        description: "Stage for managing review registrations and pre-registrations, focusing on referencing external registry entries rather than hosting registration content."
        is_a: StageExecution
        slots:
            - registrations
            - current_registration_version
            - registration_policy
        slot_usage:
            registrations:
                range: Registration
                multivalued: true
                minimum_cardinality: 1
                description: "All registrations associated with this review"
            current_registration_version:
                range: string
                description: "Identifier of the currently active registration version"
            registration_policy:
                range: RegistrationPolicy
                description: "Policy rules for registration management"

    Registration:
        description: "A registration entry referencing an external registry, with full versioning support."
        slots:
            # Core registry reference
            - stage_registration_id
            - registry_name
            - registry_entry_url
            - registration_type

            # Versioning
            - versions
            - initial_version_id
            - current_version_id

            # Metadata
            - registration_status
            - registration_created_at
            - registration_last_modified

        slot_usage:
            stage_registration_id:
                identifier: true
                required: true
                description: "Unique identifier for this registration within the review"
            registry_name:
                required: true
                description: "Name of the registry (e.g., PROSPERO, OSF, ClinicalTrials.gov)"
            registry_entry_url:
                range: uri
                required: true
                description: "URL to the registration entry in the external registry"
            registration_type:
                range: RegistrationType
                required: true
                description: "Type of registration (pre-registration or registration)"
            versions:
                range: RegistrationVersion
                multivalued: true
                minimum_cardinality: 1
                description: "All versions of this registration"
            initial_version_id:
                range: string
                required: true
                description: "ID of the initial registration version"
            current_version_id:
                range: string
                required: true
                description: "ID of the currently active version"
            registration_status:
                range: RegistrationStatus
                required: true
                description: "Current status of the registration"
            registration_created_at:
                range: datetime
                description: "When this registration record was created"
            registration_last_modified:
                range: datetime
                description: "When this registration was last modified"

    RegistrationVersion:
        description: "An immutable version of a registration, capturing the exact state at a point in time."
        slots:
            # Version identification
            - version_id
            - version_number
            - version_label

            # Registry references
            - registry_version_id
            - registry_submission_date
            - registry_acceptance_date
            - registration_doi

            # Content references
            - content_uri
            - content_hash
            - content_hash_algorithm
            - registered_text

            # Template and protocol
            - template_ref
            - registration_template_version
            - registration_template_doi
            - protocol_snapshot_hash

            # Versioning metadata
            - version_date
            - version_author
            - version_reason
            - is_major_revision

            # Amendments
            - amendments

        slot_usage:
            version_id:
                identifier: true
                required: true
                description: "Unique identifier for this version"
            version_number:
                range: string
                required: true
                description: "Semantic version number (e.g., 1.0.0, 1.1.0)"
            version_label:
                range: string
                description: "Human-readable label for this version"
            registry_version_id:
                range: string
                description: "Version identifier in the external registry"
            registry_submission_date:
                range: datetime
                required: true
                description: "When this version was submitted to the registry"
            registry_acceptance_date:
                range: datetime
                description: "When this version was accepted by the registry"
            registration_doi:
                range: string
                description: "DOI if this version has been published"
            content_uri:
                range: uri
                required: true
                description: "URI to the immutable content of this version"
            content_hash:
                range: string
                required: true
                description: "Cryptographic hash of the registration content"
            content_hash_algorithm:
                range: HashAlgorithm
                required: true
                description: "Algorithm used to generate the content hash"
            registered_text:
                range: string
                description: "Optional full text as submitted to the registry"
            template_ref:
                range: uri
                description: "Reference to the template used"
            registration_template_version:
                range: string
                description: "Version of the template used"
            registration_template_doi:
                range: string
                description: "DOI of the registration template used, if available"
            protocol_snapshot_hash:
                range: string
                description: "Hash of the exact protocol registered"
            version_date:
                range: datetime
                required: true
                description: "When this version was created"
            version_author:
                range: Author
                description: "Author who created this version"
            version_reason:
                range: string
                description: "Reason for creating this version"
            is_major_revision:
                range: boolean
                description: "Whether this is a major revision"
            amendments:
                range: Amendment
                multivalued: true
                description: "Amendments made in this version"

    Amendment:
        description: "A documented change or clarification to a registration."
        slots:
            - amendment_id
            - amendment_date
            - amendment_type
            - amendment_reason
            - amendment_description
            - affected_sections
            - affected_version_ids
            - diff_uri
            - amendment_author
            - approval_status
            - approval_date
            - approver

        slot_usage:
            amendment_id:
                identifier: true
                required: true
                description: "Unique identifier for this amendment"
            amendment_date:
                range: datetime
                required: true
                description: "Date of the amendment"
            amendment_type:
                range: AmendmentType
                required: true
                description: "Type of amendment"
            amendment_reason:
                range: string
                required: true
                description: "Human-readable reason for the amendment"
            amendment_description:
                range: string
                required: true
                description: "Detailed description of what was changed"
            affected_sections:
                range: string
                multivalued: true
                description: "Sections of the protocol affected by this amendment"
            affected_version_ids:
                range: string
                multivalued: true
                description: "IDs of versions affected by this amendment"
            diff_uri:
                range: uri
                description: "URI to an external diff showing the changes"
            amendment_author:
                range: Author
                description: "Author who made the amendment"
            approval_status:
                range: ApprovalStatus
                description: "Approval status of the amendment"
            approval_date:
                range: datetime
                description: "Date the amendment was approved"
            approver:
                range: string
                description: "Person or entity who approved the amendment"

    RegistrationPolicy:
        description: "Policy rules for registration management, can be customized by profiles."
        slots:
            - require_doi
            - require_content_hash
            - allowed_change_types
            - require_amendment_approval
            - max_days_between_versions
            - require_template
            - allowed_templates
            - hash_algorithms

        slot_usage:
            require_doi:
                range: boolean
                description: "Whether DOIs are required for registration versions"
            require_content_hash:
                range: boolean
                description: "Whether content hashes are required for verification"
            allowed_change_types:
                range: AmendmentType
                multivalued: true
                description: "Types of amendments allowed"
            require_amendment_approval:
                range: boolean
                description: "Whether amendments require formal approval"
            max_days_between_versions:
                range: integer
                description: "Maximum days allowed between version updates"
            require_template:
                range: boolean
                description: "Whether a template must be used"
            allowed_templates:
                range: uri
                multivalued: true
                description: "URIs of allowed registration templates"
            hash_algorithms:
                range: HashAlgorithm
                multivalued: true
                description: "Allowed hash algorithms for content verification"

# Slot definitions for individual properties
slots:
    # Stage-level slots
    registrations:
        description: "List of registrations for this review protocol"
        range: Registration
        multivalued: true
    current_registration_version:
        description: "Current version identifier of the registration"
        range: string
    registration_policy:
        description: "Policy governing registration amendments and changes"
        range: RegistrationPolicy
    stage_registration_id:
        description: "Unique identifier for the stage registration"
        range: string
    registry_name:
        description: "Name of the registry where protocol is registered"
        range: string
    registry_entry_url:
        description: "URL to the registration entry in the registry"
        range: uri
    registration_type:
        description: "Type of registration (pre-registration, protocol, etc.)"
        range: RegistrationType
    versions:
        description: "List of registration versions tracking changes over time"
        range: RegistrationVersion
        multivalued: true
    initial_version_id:
        description: "Identifier of the initial registration version"
        range: string
    current_version_id:
        description: "Identifier of the current registration version"
        range: string
    registration_status:
        description: "Current status of the registration"
        range: RegistrationStatus

    # Version slots
    version_id:
        description: "Unique identifier for this registration version"
        range: string
    version_number:
        description: "Version number in semantic versioning format"
        range: string
    version_label:
        description: "Human-readable label for this version"
        range: string
    registry_version_id:
        description: "Version identifier assigned by the registry"
        range: string
    registry_submission_date:
        description: "Date when version was submitted to registry"
        range: datetime
    registry_acceptance_date:
        description: "Date when version was accepted by registry"
        range: datetime
    registration_doi:
        description: "DOI assigned to this registration version"
        range: string
    content_uri:
        description: "URI to access the registered content"
        range: uri
    content_hash:
        description: "Cryptographic hash of the registered content"
        range: string
    content_hash_algorithm:
        description: "Algorithm used to generate content hash"
        range: HashAlgorithm
    registered_text:
        description: "Full text of the registered protocol"
        range: string
    template_ref:
        description: "Reference to registration template used"
        range: uri
    registration_template_version:
        description: "Version of the registration template"
        range: string
    registration_template_doi:
        description: "DOI of the registration template"
        range: string
    protocol_snapshot_hash:
        description: "Hash of protocol snapshot at registration time"
        range: string
    version_date:
        description: "Date when this version was created"
        range: datetime
    version_author:
        description: "Author who created this version"
        range: Author
    version_reason:
        description: "Reason for creating this version"
        range: string
    is_major_revision:
        description: "Whether this is a major revision"
        range: boolean
        ifabsent: false
    amendments:
        description: "List of amendments made in this version"
        range: Amendment
        multivalued: true

    # Amendment slots
    amendment_id:
        description: "Unique identifier for the amendment"
        range: string
    amendment_date:
        description: "Date when amendment was made"
        range: datetime
    amendment_type:
        description: "Type of amendment (clarification, correction, etc.)"
        range: AmendmentType
    amendment_reason:
        description: "Reason for making the amendment"
        range: string
    amendment_description:
        description: "Detailed description of the amendment"
        range: string
    affected_sections:
        description: "Protocol sections affected by this amendment"
        range: string
        multivalued: true
    affected_version_ids:
        description: "Version IDs affected by this amendment"
        range: string
        multivalued: true
    diff_uri:
        description: "URI to view differences introduced by amendment"
        range: uri
    amendment_author:
        description: "Author who made the amendment"
        range: Author
    approval_status:
        description: "Approval status of the amendment"
        range: ApprovalStatus
    approval_date:
        description: "Date when amendment was approved"
        range: datetime
    approver:
        description: "Person who approved the amendment"
        range: string

    # Policy slots
    require_doi:
        description: "Whether DOI is required for registration"
        range: boolean
        ifabsent: false
    require_content_hash:
        description: "Whether content hash is required for integrity"
        range: boolean
        ifabsent: false
    allowed_change_types:
        description: "Types of amendments allowed for this registration"
        range: AmendmentType
        multivalued: true
    require_amendment_approval:
        description: "Whether amendments require formal approval"
        range: boolean
        ifabsent: false
    max_days_between_versions:
        description: "Maximum days allowed between version updates"
        range: integer
    require_template:
        description: "Whether registration must use a template"
        range: boolean
        ifabsent: false
    allowed_templates:
        description: "List of allowed registration templates"
        range: uri
        multivalued: true
    hash_algorithms:
        description: "Hash algorithms accepted for content verification"
        range: HashAlgorithm
        multivalued: true
    registration_created_at:
        description: "Timestamp when registration was created"
        range: datetime
    registration_last_modified:
        description: "Timestamp when registration was last modified"
        range: datetime

enums:
    RegistrationType:
        description: "Type of registration"
        permissible_values:
            PRE_REGISTRATION:
                description: "Pre-registration before data collection"
            REGISTRATION:
                description: "Standard registration"
            REGISTERED_REPORT:
                description: "Registered report for journal"
            PROTOCOL_REGISTRATION:
                description: "Protocol-only registration"

    RegistrationStatus:
        description: "Status of a registration"
        permissible_values:
            DRAFT:
                description: "Registration is in draft"
            SUBMITTED:
                description: "Submitted to registry"
            UNDER_REVIEW:
                description: "Under review by registry"
            REGISTERED:
                description: "Actively registered"
            AMENDED:
                description: "Registration has been amended"
            WITHDRAWN:
                description: "Registration withdrawn"
            SUPERSEDED:
                description: "Superseded by a newer registration"

    AmendmentType:
        description: "Types of amendments to a registration"
        permissible_values:
            CLARIFICATION:
                description: "Clarification of existing content"
            CORRECTION:
                description: "Correction of errors"
            PROTOCOL_CHANGE:
                description: "Change to the protocol"
            SCOPE_CHANGE:
                description: "Change in review scope"
            METHODOLOGY_CHANGE:
                description: "Change in methodology"
            TIMELINE_CHANGE:
                description: "Change in timeline"
            TEAM_CHANGE:
                description: "Change in review team"
            ADMINISTRATIVE:
                description: "Administrative update"

    HashAlgorithm:
        description: "Cryptographic hash algorithms"
        permissible_values:
            SHA256:
                description: "SHA-256 hash"
            SHA512:
                description: "SHA-512 hash"
            SHA3_256:
                description: "SHA3-256 hash"
            SHA3_512:
                description: "SHA3-512 hash"
            BLAKE2B:
                description: "BLAKE2b hash"
            BLAKE3:
                description: "BLAKE3 hash"

    ApprovalStatus:
        description: "Approval status for amendments"
        permissible_values:
            PENDING:
                description: "Pending approval"
            APPROVED:
                description: "Approved"
            REJECTED:
                description: "Rejected"
            NOT_REQUIRED:
                description: "Approval not required"
